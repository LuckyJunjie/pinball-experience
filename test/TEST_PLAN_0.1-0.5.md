# Pinball-Experience Test Plan (Phase 0: 0.1-0.5)

**Version:** 0.1  
**Date:** 2026-02-23  
**Scope:** Baseline 0.1-0.5 功能测试  
**Project:** pinball-experience  
**Testing Framework:** 四层测试金字塔 (FIYUAN-GAME-DEVELOPMENT-FLOW)

---

## 测试体系

基于 **fuyuan-game-development-flow** 定义的 **四层测试金字塔**：

```
                    ╔═══════════════╗
                    ║  性能测试     第四层: ║  ← 帧率/内存监测
                    ║  Performance  ║
                    ╠═══════════════╣
                    ║  截图测试     ║  ← 第三层: 视觉回归测试
                    ║  Screenshot   ║
                    ╠═══════════════╣
                    ║  集成测试     ║  ← 第二层: 场景交互测试
                    ║  Integration  ║
                    ╠═══════════════╣
                    ║  单元测试     ║  ← 第一层: 函数/类测试
                    ║    Unit       ║
                    ╚═══════════════╝
              ↕ 控制台测试 (日志输出)
```

### 工具栈

| 层级 | 工具 | 状态 |
|------|------|------|
| 第一层 | GUT / GdUnit4 | 待安装 |
| 第二层 | 集成测试 | 待创建 |
| 第三层 | GDSnap / 截图验证 | 待安装 |
| 第四层 | Godot Profiler | 待验证 |
| 控制台 | Console Log | 待实现 |

---

## 0.1 发射器 + 挡板 (Launcher + Flippers)

### 功能描述
- 玩家可以发射球
- 玩家可以使用左/右挡板
- 球可以弹跳

### 测试用例

#### 第一层: 单元测试 (Unit)

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.1.1 | Ball.gd 物理参数 | mass=0.5, bounce=0.8, friction=0.3 | GUT |
| 0.1.2 | Flipper.gd 左挡板输入 | 响应 A/Left 键 | GUT |
| 0.1.3 | Flipper.gd 右挡板输入 | 响应 D/Right 键 | GUT |
| 0.1.4 | Launcher.gd 发射逻辑 | 按空格发射球，施加 impulse | GUT |

#### 第二层: 集成测试 (Integration)

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.1.5 | 发射器发射球 | 球从发射器位置生成并被弹射 | 内置 |
| 0.1.6 | 挡板击球 | 球碰到挡板后弹回 | 内置 |

#### 第三层: 截图测试 (Screenshot)

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.1.7 | 游戏启动截图 | Main.tscn 正常加载，无报错 | GDSnap |
| 0.1.8 | 发射球截图 | 球从发射器射出 | GDSnap |

#### 控制台测试 (Console)

| ID | 测试用例 | 预期输出 |
|----|----------|----------|
| 0.1.9 | 游戏启动日志 | `[INFO] GameManager: 游戏初始化完成` |
| 0.1.10 | 发射球日志 | `[INFO] Launcher: 球已发射` |

---

## 0.2 排水口 (Drain)

### 功能描述
- 球进入排水口后被移除
- 球移除后触发 round_lost

### 测试用例

#### 第一层: 单元测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.2.1 | Drain.gd 触发逻辑 | 球进入 Drain 时调用 queue_free() | GUT |

#### 第二层: 集成测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.2.2 | 球进入排水口 | 球被移除，触发 on_ball_removed() | 内置 |
| 0.2.3 | 球数归零 | get_ball_count() <= 0 时触发 on_round_lost() | 内置 |

#### 第三层: 截图测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.2.4 | 球掉入排水口截图 | 球从场景中消失 | GDSnap |

#### 控制台测试

| ID | 测试用例 | 预期输出 |
|----|----------|----------|
| 0.2.5 | 球掉入排水口日志 | `[INFO] Drain: 球已移除` |
| 0.2.6 | 回合结束日志 | `[INFO] GameManager: 回合结束, 分数: xxx` |

---

## 0.3 墙壁和边界 (Walls)

### 功能描述
- 球被限制在游戏区域内
- 球从墙壁反弹

### 测试用例

#### 第二层: 集成测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.3.1 | 场景墙壁验证 | 左/右/上墙壁 StaticBody2D 存在 | 内置 |
| 0.3.2 | 球碰墙壁 | 球从墙壁反弹不穿透 | 内置 |

#### 第三层: 截图测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.3.3 | 球碰墙截图 | 球在边界内弹跳 | GDSnap |

---

## 0.4 障碍物 + 计分 (Obstacles + Scoring)

### 功能描述
- 障碍物被击中时得分
- UI 显示当前分数

### 测试用例

#### 第一层: 单元测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.4.1 | Obstacle.gd 计分逻辑 | 碰撞时调用 GameManager.add_score(points) | GUT |
| 0.4.2 | GameManager.add_score | 分数正确累加，受 status 状态控制 | GUT |

#### 第二层: 集成测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.4.3 | 击中障碍物 | 分数增加对应点数 (5000/20000) | 内置 |
| 0.4.4 | UI 分数显示 | HUD 显示正确分数 | 内置 |

#### 第三层: 截图测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.4.5 | 障碍物显示截图 | 3个障碍物可见且位置正确 | GDSnap |
| 0.4.6 | 得分显示截图 | 击中后分数变化 | GDSnap |

#### 控制台测试

| ID | 测试用例 | 预期输出 |
|----|----------|----------|
| 0.4.7 | 击中障碍物日志 | `[INFO] GameManager: 得分 +5000 (Obstacle1)` |

---

## 0.5 回合 + 游戏结束 (Rounds + Game Over)

### 功能描述
- 3个回合
- 回合结束后进入下一回合或游戏结束
- 显示最终分数
- 可重玩

### 测试用例

#### 第一层: 单元测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.5.1 | GameManager 状态机 | status: waiting → playing → gameOver | GUT |
| 0.5.2 | 回合逻辑 | rounds 初始为3，round_lost 时 -1 | GUT |
| 0.5.3 | 分数计算 | total_score += round_score × multiplier | GUT |

#### 第二层: 集成测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.5.4 | 第一次球掉出 | rounds=2，生成新球 | 内置 |
| 0.5.5 | 第二次球掉出 | rounds=1，生成新球 | 内置 |
| 0.5.6 | 第三次球掉出 | rounds=0，触发 game_over | 内置 |
| 0.5.7 | 重玩功能 | 点击 Replay 按钮重新开始游戏 | 内置 |

#### 第三层: 截图测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| 0.5.8 | 游戏结束界面截图 | GameOverPanel 显示最终分数 | GDSnap |
| 0.5.9 | 重玩截图 | 重新开始游戏 | GDSnap |

#### 控制台测试

| ID | 测试用例 | 预期输出 |
|----|----------|----------|
| 0.5.10 | 游戏开始日志 | `[INFO] GameManager: 游戏开始, 回合: 3` |
| 0.5.11 | 回合转换日志 | `[INFO] GameManager: 回合 2/3 开始` |
| 0.5.12 | 游戏结束日志 | `[INFO] GameManager: 游戏结束, 最终分数: xxxxx` |

---

## 额外测试用例

### 输入系统

#### 第二层: 集成测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| IN-01 | 左挡板输入 | 按 A 或 Left 键激活左挡板 | 内置 |
| IN-02 | 右挡板输入 | 按 D 或 Right 键激活右挡板 | 内置 |
| IN-03 | 发射球输入 | 按 Space 或 Down 键发射球 | 内置 |

### 音效系统

#### 第二层: 集成测试

| ID | 测试用例 | 预期结果 | 工具 |
|----|----------|----------|------|
| SND-01 | SoundManager 存在 | SoundManager 作为 autoload | 内置 |
| SND-02 | 发射音效 | 球发射时播放 ball_launch | 内置 |
| SND-03 | 失落音效 | 球掉入排水口时播放 ball_lost | 内置 |

---

## 测试执行命令

### 单元测试 (GUT/GdUnit4)

```bash
# 运行单元测试
godot --headless --path . -s addons/gut/gut_cmdln.gd -testdir=res://test/unit/
```

### 集成测试

```bash
# 运行集成测试
godot --headless --path . -s test/integration/run_tests.gd
```

### 截图测试

```bash
# 运行截图测试
./test/run_screenshot_tests.sh
```

### 控制台测试

```bash
# 运行测试并捕获输出
godot --headless --path . -s test/run_tests.gd 2>&1 | tee test.log

# 分析结果
grep -E "\[INFO\]|\[ERROR\]|得分" test.log
```

### 完整测试

```bash
# 运行全部测试
./test/run_all_tests.sh
```

---

## 测试目录结构

```
pinball-experience/
├── test/
│   ├── unit/                    # 单元测试
│   │   ├── test_ball.gd
│   │   ├── test_flipper.gd
│   │   ├── test_launcher.gd
│   │   ├── test_drain.gd
│   │   ├── test_obstacle.gd
│   │   └── test_game_manager.gd
│   ├── integration/             # 集成测试
│   │   ├── test_launcher_flipper.gd
│   │   ├── test_drain_round.gd
│   │   ├── test_scoring.gd
│   │   └── test_game_over.gd
│   ├── screenshot/              # 截图测试
│   │   ├── baseline/           # 基准截图
│   │   └── current/            # 当前截图
│   ├── console/                 # 控制台测试
│   │   └── console_tests.md
│   └── run_tests.gd            # 测试运行器
└── doc/
    └── testing_process.md
```

---

## 通过标准

| 层级 | 必须通过 |
|------|----------|
| 第一层: 单元测试 | ✅ 必须通过 |
| 第二层: 集成测试 | ✅ 必须通过 |
| 第三层: 截图测试 | ⚠️ 推荐通过 |
| 第四层: 性能测试 | ⚠️ 可选 |
| 控制台测试 | ✅ 必须通过 |

---

## 已报告的 Bug

1. 🐛 Drain 位置问题 - 排水口与挡板距离过大
2. 🐛 UI 布局问题 - 需要验证在不同分辨率下的显示

---

## 执行记录

| 日期 | 测试项 | 结果 | 备注 |
|------|--------|------|------|
| 2026-02-23 | 代码分析 | ✅ | 已分析主要脚本 |
| 2026-02-23 | Bug 报告 | ✅ | 已添加到 Bitable |
| 2026-02-23 | 测试计划创建 | ✅ | 四层测试体系 |
| 2026-02-23 | 项目克隆 | ✅ | 使用 ghfast.top 镜像 |
